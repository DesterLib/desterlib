#!/usr/bin/env node

/**
 * Changelog Sync Script
 *
 * This script syncs package-specific CHANGELOG.md files (generated by Changesets)
 * to their respective documentation pages.
 */

const fs = require("fs");
const path = require("path");

// ANSI color codes for terminal output
const colors = {
  reset: "\x1b[0m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  red: "\x1b[31m",
  blue: "\x1b[34m",
};

function log(message, color = "reset") {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// Package changelog paths and their corresponding docs pages
const packageChangelogs = [
  {
    name: "API Server",
    packageName: "api",
    changelogPath: path.join(__dirname, "../apps/api/CHANGELOG.md"),
    docsPath: path.join(
      __dirname,
      "../apps/docs/src/content/docs/api/changelog.md"
    ),
    githubPath: "apps/api/CHANGELOG.md",
    description: "Changelog for the DesterLib API Server",
  },
  {
    name: "CLI Tool",
    packageName: "@desterlib/cli",
    changelogPath: path.join(__dirname, "../packages/cli/CHANGELOG.md"),
    docsPath: path.join(
      __dirname,
      "../apps/docs/src/content/docs/cli/changelog.md"
    ),
    githubPath: "packages/cli/CHANGELOG.md",
    description: "Changelog for the DesterLib CLI Tool",
  },
  {
    name: "Documentation",
    packageName: "docs",
    changelogPath: path.join(__dirname, "../apps/docs/CHANGELOG.md"),
    docsPath: path.join(
      __dirname,
      "../apps/docs/src/content/docs/docs/changelog.md"
    ),
    githubPath: "apps/docs/CHANGELOG.md",
    description: "Changelog for the DesterLib Documentation",
  },
];

const GITHUB_REPO = "https://github.com/DesterLib/desterlib";

/**
 * Parse changelog content and extract meaningful content
 */
function parseChangelog(content) {
  if (!content || !content.trim()) {
    return null;
  }

  // Remove any frontmatter if present
  content = content.replace(/^---\s*[\s\S]*?---\s*/, "").trim();

  // Remove the main title (usually package name as # heading)
  // Changesets typically starts with "# package-name"
  content = content
    .replace(/^#\s+[^\n]+\n*/i, "")
    .replace(/^#\s+Changelog\s*/i, "")
    .trim();

  // If content is empty after removing title, return null
  if (!content || content.trim().length === 0) {
    return null;
  }

  return content;
}

/**
 * Sync a single package changelog to its docs page
 */
function syncPackageChangelog(pkg) {
  let changelogContent = null;

  // Read package changelog if it exists
  if (fs.existsSync(pkg.changelogPath)) {
    try {
      const content = fs.readFileSync(pkg.changelogPath, "utf8");
      changelogContent = parseChangelog(content);

      if (!changelogContent || !changelogContent.trim()) {
        log(`‚ö†Ô∏è  ${pkg.name} changelog is empty`, "yellow");
      } else {
        log(`‚úì  Found ${pkg.name} changelog`, "green");
      }
    } catch (error) {
      log(`‚ùå Error reading ${pkg.name} changelog: ${error.message}`, "red");
    }
  } else {
    log(
      `‚ö†Ô∏è  Warning: ${pkg.name} changelog not found at ${pkg.changelogPath}`,
      "yellow"
    );
  }

  // Build docs page content
  // Note: We don't include an H1 heading here because the frontmatter title provides it
  // Starlight/Astro will use the frontmatter title, not an H1 in the content
  let docsContent = `---
title: ${pkg.name} Changelog
description: ${pkg.description}
---

All notable changes to ${pkg.name} will be documented here.

This changelog is automatically generated from [Changesets](https://github.com/changesets/changesets).

See the [${pkg.name} Changelog on GitHub](${GITHUB_REPO}/blob/main/${pkg.githubPath}) for the source file.

---

`;

  if (changelogContent && changelogContent.trim()) {
    // Add the changelog content
    docsContent += changelogContent;
  } else {
    // Add placeholder if no changelog exists
    docsContent += `_No changelog entries yet. Changelog will appear here once versions are bumped._\n`;
  }

  // Ensure docs directory exists
  const docsDir = path.dirname(pkg.docsPath);
  if (!fs.existsSync(docsDir)) {
    fs.mkdirSync(docsDir, { recursive: true });
  }

  // Write to docs
  fs.writeFileSync(pkg.docsPath, docsContent);

  return {
    success: true,
    hasContent: changelogContent !== null && changelogContent.trim().length > 0,
  };
}

try {
  log("\nüìù Syncing package changelogs to docs", "blue");
  log("‚îÄ".repeat(50), "blue");

  let syncedCount = 0;
  let contentCount = 0;

  // Sync each package changelog
  for (const pkg of packageChangelogs) {
    const result = syncPackageChangelog(pkg);
    if (result.success) {
      syncedCount++;
      if (result.hasContent) {
        contentCount++;
      }
    }
  }

  log("");
  log(`‚úÖ Synced ${syncedCount} changelog(s) to docs`, "green");
  log(`‚úì  ${contentCount} changelog(s) have content`, "yellow");
  log("");
} catch (error) {
  log(`‚ùå Error syncing changelogs: ${error.message}`, "red");
  log(error.stack, "red");
  process.exit(1);
}

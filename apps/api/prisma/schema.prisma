generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MediaType {
  MOVIE
  TV_SHOW
  MUSIC
  COMIC
}

model Media {
  id                  String    @id @default(cuid())
  title               String
  type                MediaType
  description         String?
  posterUrl           String?
  plainPosterUrl      String?   // Poster without language-specific text
  backdropUrl         String?
  logoUrl             String?   // Logo image in English
  meshGradientColors  String[]  // Hex colors for mesh gradient (4 colors for corners)
  releaseDate         DateTime?
  rating              Float?
  
  // File info (optional, for simple file-based media or as a fallback)
  filePath            String?
  fileSize            BigInt?
  fileModifiedAt      DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations - subtypes point to Media, not the other way around
  movies Movie[]
  tvShow TVShow?
  music  Music?
  comic  Comic?

  people      MediaPerson[]
  genres      MediaGenre[]
  externalIds ExternalId[]
  libraries MediaLibrary[]

  @@index([type])
  @@index([releaseDate])
  @@index([rating])
  @@index([title])
}

// ────────────────────────────
// MOVIES
// ────────────────────────────

model Movie {
  id             String    @id @default(cuid())
  duration       Int? // in minutes
  trailerUrl     String?
  filePath       String?   @unique // File path on disk
  fileSize       BigInt? // File size in bytes
  fileModifiedAt DateTime? // Last modified time of file
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Required relationship to Media
  mediaId        String
  media          Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([filePath])
  @@index([mediaId])
}

// ────────────────────────────
// TV SHOWS
// ────────────────────────────

model TVShow {
  id      String   @id @default(cuid())
  seasons Season[]
  creator String?
  network String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Required relationship to Media
  mediaId String   @unique
  media   Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
}

model Season {
  id        String    @id @default(cuid())
  number    Int
  posterUrl String?   // Season poster image URL
  episodes  Episode[]
  tvShowId  String
  tvShow    TVShow    @relation(fields: [tvShowId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([tvShowId, number])
  @@index([tvShowId])
}

model Episode {
  id             String    @id @default(cuid())
  title          String
  fileTitle      String? // Title extracted from filename
  number         Int
  duration       Int?
  airDate        DateTime?
  stillPath      String?   // Episode still/screenshot image URL
  filePath       String?   @unique // File path on disk
  fileSize       BigInt? // File size in bytes
  fileModifiedAt DateTime? // Last modified time of file
  seasonId       String
  season         Season    @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([seasonId, number])
  @@index([seasonId])
  @@index([filePath])
}

// ────────────────────────────
// MUSIC
// ────────────────────────────

model Music {
  id             String    @id @default(cuid())
  artist         String
  album          String?
  genre          String?
  duration       Int?
  filePath       String?   @unique // File path on disk
  fileSize       BigInt? // File size in bytes
  fileModifiedAt DateTime? // Last modified time of file
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Required relationship to Media
  mediaId        String    @unique
  media          Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([artist])
  @@index([genre])
  @@index([filePath])
}

// ────────────────────────────
// COMICS
// ────────────────────────────

model Comic {
  id             String    @id @default(cuid())
  issue          Int?
  volume         String?
  publisher      String?
  pages          Int?
  filePath       String?   @unique // File path on disk
  fileSize       BigInt? // File size in bytes
  fileModifiedAt DateTime? // Last modified time of file
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Required relationship to Media
  mediaId        String    @unique
  media          Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([publisher])
  @@index([filePath])
}

// ────────────────────────────
// PERSON
// ────────────────────────────

enum RoleType {
  ACTOR
  DIRECTOR
  WRITER
  PRODUCER
  ARTIST
  COMPOSER
  AUTHOR
}

model Person {
  id         String    @id @default(cuid())
  name       String
  bio        String?
  birthDate  DateTime?
  profileUrl String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Media relationships
  media MediaPerson[]

  @@index([name])
}

// ────────────────────────────
// JOIN TABLE (MEDIA ↔ PERSON)
// ────────────────────────────

model MediaPerson {
  id        String   @id @default(cuid())
  role      RoleType
  mediaId   String
  personId  String
  character String? // e.g., "Bruce Wayne"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media  Media  @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([mediaId, personId, role])
  @@index([mediaId])
  @@index([personId])
}

// ────────────────────────────
// GENRES
// ────────────────────────────

model Genre {
  id          String   @id @default(cuid())
  name        String   @unique // Canonical normalized name (e.g., "Science Fiction")
  slug        String   @unique // URL-friendly slug (e.g., "science-fiction")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  media MediaGenre[]

  @@index([slug])
  @@index([name])
}

// ────────────────────────────
// JOIN TABLE (MEDIA ↔ GENRE)
// ────────────────────────────

model MediaGenre {
  id      String @id @default(cuid())
  mediaId String
  genreId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([mediaId, genreId])
  @@index([mediaId])
  @@index([genreId])
}

// ────────────────────────────
// LIBRARIES
// ────────────────────────────

model Library {
  id          String               @id @default(cuid())
  name        String
  slug        String               @unique
  description String?
  posterUrl   String?
  backdropUrl String?

  isLibrary   Boolean              @default(false)
  libraryPath String? 
  libraryType MediaType? 

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  parentId String?
  parent   Library?  @relation("LibraryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Library[] @relation("LibraryHierarchy")

  media      MediaLibrary[]
  scanJobs   ScanJob[]

  @@index([slug])
  @@index([parentId])
  @@index([isLibrary])
  @@index([libraryPath])
}

// ────────────────────────────
// JOIN TABLE (MEDIA ↔ LIBRARY)
// ────────────────────────────

model MediaLibrary {
  id           String @id @default(cuid())
  mediaId      String
  libraryId String
  order        Int? // For ordering media within a library

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  media      Media      @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  library Library @relation(fields: [libraryId], references: [id], onDelete: Cascade)

  @@unique([mediaId, libraryId])
  @@index([mediaId])
  @@index([libraryId])
  @@index([order])
}

// ────────────────────────────
// EXTERNAL IDS (TMDB, IMDB, etc.)
// ────────────────────────────

enum ExternalIdSource {
  TMDB
  IMDB
  TVDB
  ANIDB
  MYANIMELIST
  MUSICBRAINZ
  SPOTIFY
  COMICVINE
  OTHER
}

model ExternalId {
  id         String           @id @default(cuid())
  source     ExternalIdSource
  externalId String
  mediaId    String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([source, externalId])
  @@unique([source, mediaId])
  @@index([mediaId])
  @@index([externalId])
}

// ────────────────────────────
// SCAN JOBS
// ────────────────────────────

enum ScanJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  PAUSED
}

enum MetadataJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  NOT_STARTED // Metadata provider not configured when scan completed
}

model ScanJob {
  id                  String        @id @default(cuid())
  libraryId           String
  scanPath            String
  mediaType           MediaType
  status              ScanJobStatus @default(PENDING) // Status of file scanning
  metadataStatus      MetadataJobStatus @default(NOT_STARTED) // Status of metadata fetching
  scannedCount        Int           @default(0) // Number of files scanned
  metadataSuccessCount Int          @default(0) // Number of successful metadata fetches
  metadataFailedCount  Int          @default(0) // Number of failed metadata fetches
  
  startedAt           DateTime?
  completedAt        DateTime?
  metadataStartedAt   DateTime? // When metadata processing started
  metadataCompletedAt DateTime? // When metadata processing completed
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  library Library @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  
  @@index([libraryId])
  @@index([status])
  @@index([metadataStatus])
  @@index([scanPath])
}

// ────────────────────────────
// METADATA PROVIDERS
// ────────────────────────────

/// Metadata provider configurations (TMDB, OMDB, etc.)
model MetadataProvider {
  id        String   @id // UUID as string
  name      String   @unique // e.g., "tmdb", "omdb"
  enabled   Boolean  @default(true)
  priority  Int      @default(0) // Lower number = higher priority
  config    Json     @default("{}") // Provider-specific configuration
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([enabled, priority])
  @@map("MetadataProvider")
}

// ────────────────────────────
// SETTINGS
// ────────────────────────────

/// Setting categories for organizing configuration
enum SettingCategory {
  CORE        // Core system settings
  INTEGRATION // External integrations (TMDB, Plex, etc.)
  LIBRARY     // Library management
  TRANSCODING // Media transcoding
  NETWORK     // Network and streaming
  NOTIFICATION // Notifications
  UI          // User interface
  PLUGIN      // Plugin-specific
  CUSTOM      // User-defined
}

/// Setting data types for validation
enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET  // Encrypted/sensitive values
}

/// Modular settings table - future-proof for plugins and extensions
model Setting {
  id          String          @id @default(cuid())
  key         String          @unique
  category    SettingCategory @default(CUSTOM)
  module      String?
  value       String
  type        SettingType     @default(STRING)
  displayName String?
  description String?
  isPublic    Boolean         @default(false)
  isRequired  Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([category])
  @@index([module])
  @@map("Setting")
}